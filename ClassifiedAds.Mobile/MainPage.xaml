<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:ClassifiedAds.Mobile.ViewModels"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="ClassifiedAds.Mobile.MainPage"
             BackgroundColor="{AppThemeBinding Light={StaticResource PageBgLight}, Dark={StaticResource PageBgDark}}"
             Title="Home">

    <ContentPage.BindingContext>
        <vm:CategoriesViewModel />
    </ContentPage.BindingContext>

    <ContentPage.Resources>
        <toolkit:InvertedBoolConverter x:Key="InvertedBoolConverter" />
    </ContentPage.Resources>

    <Shell.NavBarIsVisible>False</Shell.NavBarIsVisible>

    <Grid RowDefinitions="Auto, *">

        <Grid Grid.Row="0" ZIndex="10">

            <Grid BackgroundColor="{StaticResource BrandOrange}" 
                  Padding="0,0,0,50"
                  IsVisible="{Binding IsSearching, Converter={StaticResource InvertedBoolConverter}}">

                <VerticalStackLayout Spacing="15" Padding="20,50,20,40">
                    <Label Text="Find the best deals for you" 
                           TextColor="White" 
                           HorizontalOptions="Center" 
                           FontSize="16"/>

                    <Button Text="+ POST NEW AD"
                            Command="{Binding PostAdCommand}"
                            BackgroundColor="{AppThemeBinding Light={StaticResource CardBgLight}, Dark={StaticResource CardBgDark}}"
                            TextColor="{StaticResource BrandOrange}"
                            FontAttributes="Bold"
                            CornerRadius="8"
                            HeightRequest="50">
                        <Button.Shadow>
                            <Shadow Brush="Black" Offset="0,4" Radius="5" Opacity="0.2"/>
                        </Button.Shadow>
                    </Button>
                </VerticalStackLayout>
            </Grid>

            <Border StrokeShape="RoundRectangle 10"
                    StrokeThickness="1"
                    Stroke="{AppThemeBinding Light=#E0E0E0, Dark=Transparent}" 
                    BackgroundColor="{AppThemeBinding Light={StaticResource CardBgLight}, Dark={StaticResource CardBgDark}}"
                    Padding="10,0"
                    HeightRequest="50">

                <Border.Shadow>
                    <Shadow Brush="Black" Offset="0,4" Radius="6" Opacity="0.15"/>
                </Border.Shadow>

                <Border.Triggers>
                    <DataTrigger TargetType="Border" Binding="{Binding IsSearching}" Value="False">
                        <Setter Property="Margin" Value="20,0,20,-25" />
                        <Setter Property="VerticalOptions" Value="End" />
                    </DataTrigger>

                    <DataTrigger TargetType="Border" Binding="{Binding IsSearching}" Value="True">
                        <Setter Property="Margin" Value="10,10,10,10" />
                        <Setter Property="VerticalOptions" Value="Start" />
                    </DataTrigger>
                </Border.Triggers>

                <Grid ColumnDefinitions="Auto, *">
                    <ImageButton Grid.Column="0" 
                                 Source="dotnet_bot.png"
                                 Command="{Binding CancelSearchCommand}"
                                 Aspect="AspectFit" 
                                 HeightRequest="25"
                                 WidthRequest="40"
                                 IsVisible="{Binding IsSearching}">
                        <ImageButton.Behaviors>
                            <toolkit:IconTintColorBehavior TintColor="{StaticResource BrandOrange}" />
                        </ImageButton.Behaviors>
                    </ImageButton>

                    <Image Grid.Column="0" 
                           Source="dotnet_bot.png" 
                           Aspect="AspectFit" 
                           HeightRequest="20"
                           WidthRequest="40"
                           IsVisible="{Binding IsSearching, Converter={StaticResource InvertedBoolConverter}}"/>

                    <Entry Grid.Column="1" 
                           Text="{Binding SearchText}"
                           Placeholder="Search by item, car, or part..." 
                           TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"
                           PlaceholderColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                           VerticalOptions="Center"
                           BackgroundColor="Transparent">
                        <Entry.Behaviors>
                            <toolkit:EventToCommandBehavior EventName="Focused" Command="{Binding StartSearchCommand}" />
                            <toolkit:EventToCommandBehavior EventName="TextChanged" Command="{Binding PerformSearchCommand}" CommandParameter="{Binding Text, Source={RelativeSource Self}}" />
                        </Entry.Behaviors>
                    </Entry>
                </Grid>
            </Border>
        </Grid>

        <CollectionView Grid.Row="1" 
                        ItemsSource="{Binding Categories}"
                        SelectionMode="None"
                        Margin="0,35,0,0" 
                        ZIndex="1"
                        IsVisible="{Binding IsSearching, Converter={StaticResource InvertedBoolConverter}}">
            <CollectionView.ItemsLayout>
                <LinearItemsLayout Orientation="Vertical" ItemSpacing="10"/>
            </CollectionView.ItemsLayout>

            <CollectionView.Header>
                <BoxView HeightRequest="10" Color="Transparent"/>
            </CollectionView.Header>
            <CollectionView.Footer>
                <BoxView HeightRequest="0" Color="Transparent"/>
            </CollectionView.Footer>

            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Frame BackgroundColor="{AppThemeBinding Light={StaticResource CardBgLight}, Dark={StaticResource CardBgDark}}"
                           CornerRadius="8"
                           Padding="15"
                           Margin="15,0"
                           HasShadow="True"
                           BorderColor="Transparent"
                           HeightRequest="80">
                        <Grid ColumnDefinitions="80, *">
                            <Image Grid.Column="0" Source="{Binding ImageSource}" Aspect="AspectFit"/>
                            <Label Grid.Column="1" Text="{Binding Title}" 
                                   TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"
                                   FontSize="18" FontAttributes="Bold" VerticalOptions="Center" Margin="15,0,0,0"/>
                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <CollectionView Grid.Row="1" 
                        ItemsSource="{Binding SearchResults}"
                        Margin="0,0,0,0"
                        ZIndex="5"
                        SelectionMode="None"
                        IsVisible="{Binding IsSearching}">
            <CollectionView.Header>
                <Label Text="Search Results" FontSize="14" TextColor="{StaticResource TextSecondaryLight}" Margin="20,10"/>
            </CollectionView.Header>
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Grid Padding="20,15" BackgroundColor="Transparent">
                        <Label Text="{Binding .}" FontSize="16" TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"/>
                        <BoxView HeightRequest="1" Color="{StaticResource SeparatorLight}" VerticalOptions="End"/>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

    </Grid>
</ContentPage>