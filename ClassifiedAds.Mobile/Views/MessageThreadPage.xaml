<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:ClassifiedAds.Mobile.ViewModels"
             x:Class="ClassifiedAds.Mobile.Views.MessageThreadPage"
             Title="Messages"
             Shell.TabBarIsVisible="False">

    <Grid RowDefinitions="*, Auto" Padding="0" BackgroundColor="White">

        <CollectionView x:Name="MessagesList"
                        Grid.Row="0"
                        ItemsSource="{Binding Messages}"
                        ItemsLayout="VerticalList"
                        Margin="10">
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Grid Padding="0,5">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="45" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="45" />
                        </Grid.ColumnDefinitions>

                        <Border Grid.Column="0"
                                StrokeShape="RoundRectangle 22"
                                HeightRequest="44"
                                WidthRequest="44"
                                StrokeThickness="0"
                                VerticalOptions="Start"
                                IsVisible="{Binding IsMine, Converter={StaticResource InvertedBoolConverter}}">
                            <Image Aspect="AspectFill">
                                <Image.Source>
                                    <UriImageSource Uri="{Binding SenderImageUrl}" 
                                                    CachingEnabled="True" 
                                                    CacheValidity="14:00:00:00" />
                                </Image.Source>
                            </Image>
                        </Border>

                        <VerticalStackLayout Grid.Column="1"
                                             HorizontalOptions="{Binding Alignment}"
                                             Spacing="2"
                                             Padding="5,0">

                            <Label Text="{Binding SenderDisplayName}"
                                   FontSize="10"
                                   TextColor="Gray"
                                   Margin="2,0,2,0"
                                   HorizontalOptions="{Binding Alignment}"/>

                            <Border BackgroundColor="{Binding BubbleColor}"
                                    StrokeShape="RoundRectangle 15"
                                    StrokeThickness="0"
                                    Padding="12,10">
                                <Label Text="{Binding Content}" 
                                       TextColor="{Binding TextColor}" 
                                       FontSize="15"/>
                            </Border>

                            <HorizontalStackLayout Spacing="5" HorizontalOptions="{Binding Alignment}">
                                <Label Text="{Binding StatusText}"
                                       FontSize="10"
                                       TextColor="Gray"
                                       IsVisible="{Binding IsMine}"/>

                                <Label Text="{Binding MessageSent, StringFormat='{0:hh:mm tt}'}" 
                                       FontSize="10" 
                                       TextColor="LightGray"/>
                            </HorizontalStackLayout>
                        </VerticalStackLayout>

                        <Border Grid.Column="2"
                                StrokeShape="RoundRectangle 22"
                                HeightRequest="44"
                                WidthRequest="44"
                                StrokeThickness="0"
                                VerticalOptions="Start"
                                IsVisible="{Binding IsMine}">
                            <Image Aspect="AspectFill">
                                <Image.Source>
                                    <UriImageSource Uri="{Binding SenderImageUrl}" 
                                                    CachingEnabled="True" 
                                                    CacheValidity="14:00:00:00" />
                                </Image.Source>
                            </Image>
                        </Border>

                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <Grid Grid.Row="1" ColumnDefinitions="*, Auto" Padding="10,10" ColumnSpacing="10" BackgroundColor="White">
            <Border Grid.Column="0" Stroke="#E0E0E0" StrokeShape="RoundRectangle 20" HeightRequest="45" Padding="10,0">
                <Entry Text="{Binding NewMessageContent}" 
                       Placeholder="Enter your message" 
                       TextColor="Black" 
                       PlaceholderColor="Gray"
                       VerticalOptions="Center"/>
            </Border>

            <Button Grid.Column="1" 
                    Text="Send" 
                    Command="{Binding SendMessageCommand}" 
                    BackgroundColor="#5243E4" 
                    TextColor="White" 
                    CornerRadius="10" 
                    FontAttributes="Bold" 
                    HeightRequest="45" 
                    WidthRequest="70"/>
        </Grid>

    </Grid>
</ContentPage>